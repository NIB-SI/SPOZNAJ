---
title: "income"
author: "zagor"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: true
      smooth_scroll: true
    fig_caption: yes
    self_contained: yes
    fig_width: 12
    fig_height: 9
    number_sections: yes
    theme: flatly
    highlight: tango
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}

knitr::opts_chunk$set(#dev = c('pdf', 'png'),
                      dev = c('png', 'svg', 'pdf'), 
                      fig.align = 'center', 
                      fig.height = 9, 
                      fig.width = 12,
                      warning = FALSE, message = FALSE, echo = TRUE
                      )


```


```{r}

rm(list = ls(all = TRUE))
gc()


```


# initialize ```renv```


```{r}

# install.packages("renv")
renv::init()


```


# packages

```{r}

library(magrittr)

library(data.table)

library(ggplot2)
library(svglite)

```


# palette

```{r}

pal = rev(RColorBrewer::brewer.pal(8, 'Paired'))
barplot(
  rep(1, length(pal)),
  col = pal,
  border = NA,
  names.arg = paste0("Color ", seq_along(pal)),
  main = "Reversed Paired Palette (8 colors)",
  las = 2
)


```


# data


<https://pxweb.stat.si/SiStatData/pxweb/en/Data/Data/0867347S.px/chart/chartViewColumn/>

Notes:

- INCOME AFTER SOCIAL TRANSFERS 
  - is (net) disposable household income. 
  - It is calculated as the sum of net incomes (in cash) of all household members (employee cash or near cash income, including supplement for meals and transport to work, cash benefits or loses from self-employment, pensions, unemployment benefits, sickness benefits, education-related allowances, family allowances and social benefits, interests, dividends, regular inter-household cash transfers received) less regular inter-household cash transfers paid and regular taxes on wealth, including compensation for the use of building land. 
  - To income in cash calculated in this way part of income in kind (benefit for the use of company car for private purposes and the value of withdrawals from a business by a self-employed person) is added.
  
- INCOME BEFORE SOCIAL TRANSFERS 
  - is (net) disposable household income less social transfers (e.g. unemployment insurance, paid sick leave compensation, scholarship, child allowance, maternity leave compensation, adoptive parents' compensation, allowance for nursing a child, assistance for goods for a new-born child, large family allowance, fathers' compensation, parental allowance, financial social assistance, allowance for help and care, housing subsidies, disability benefits, old-age benefits, survivors' benefits). 
  - It is calculated using two definitions of income, depending on whether pensions are considered as social transfers or not: only » family benefits, disability pensions and other social transfers« or »social transfers including all pensions (old-age and survivors’ benefits)« are subtracted from total income.
  - In calculating the mean and the median, for income before social transfers the same number of persons is taken into account as for income after social transfers in an individual breakdown, so in some breakdowns for income before social transfers the value of the median inome can be very low or even negative.
  
- MEASURES
  - The OECD modified scale is used for the calculation of the EQUIVALISED INCOME (income per equivalent adult household member). The scale gives to the first adult in the household weight 1, to every other person aged 14 or more weight 0.5 and to children under 14 weight 0.3.
  
- YEAR
  - Income, poverty and social exclusion indicators are published for the SILC (Statistics on Income and Living Conditions) survey year. The data on income for calculating these indicators are from a year earlier, i.e. the year before the survey is conducted. With the 2022 EU-SILC survey, the methodology for calculating income before social transfers has changed slightly, so the data for income before social transfers from 2022 on are not completely comparable with the data for previous years. 




```{r}

fp = file.path('..', 'input')
fn = "0867347S_20251103-205718.xlsx"
dt = openxlsx::read.xlsx(file.path(fp, fn), sheet = 'data', rows = 2:580)
dt = dt %>% tidyr::fill(X1:X5, .direction = "down")

colnames(dt)[1:5] = c('measureType', 'ageCohort', 'Education', 'Gender', 'incomeType')
setDT(dt)
dt

dt.long = dt %>%
  tidyr::pivot_longer(
    cols = matches("^\\d{4}$"),  
    names_to = "Year",
    values_to = "Income"
  ) %>%
  dplyr::mutate(Year = as.integer(Year)) 

table(dt.long$measureType, dt.long$ageCohort)

dt.long = dt.long[dt.long$ageCohort %in% "Age 18-64" & grep('^Mean income', dt.long$measureType), ]
table(dt.long$Gender, dt.long$Education)
dt.long = dt.long[dt.long$Gender != "Gender - TOTAL" , ]
table(dt.long$incomeType, dt.long$Year)
dt.long = dt.long[grep('not', dt.long$incomeType, invert = TRUE) , ]
dt.long = dt.long[! dt.long$Year  %in% c(2022,2023,2024), ]

```

# refine variables

```{r}


dt.long$incomeType = gsub(" \\(.*", "", dt.long$incomeType)


dt.long = dt.long %>%
  dplyr::mutate(across(-Income, as.factor))

dt.long = dt.long %>%
  dplyr::mutate(Education = factor(Education, levels = c(
    "Basic or less",
    "Vocational secondary",
    "Technical, general upper secondary",
    "Tertiary"
  )))
  
dt.long = dt.long %>%
  dplyr::mutate(incomeType = factor(incomeType, levels = c(
    "Income before social transfers",
    "Income after social transfers"
  )))


```

# basic plot

```{r}

ggplot(dt.long, aes(x = Gender, y = Income, fill = interaction(incomeType, Gender))) +
  geom_boxplot(outlier.shape = 21, outlier.fill = "white") +
  facet_wrap(~ Education, ncol = 8) +
  labs(
    title = "Distribution of Income",
    subtitle = "Boxplots by Gender, Faceted by Education",
    x = "Gender",
    y = "Income Difference"
  ) +
  theme_minimal() +
  geom_hline(yintercept = 0, alpha = 0) +
  scale_fill_manual(values = pal[c(8,7, 2,1)]) +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 2, ncol = 2, title = NULL)) +
  stat_summary(
    aes(x = Gender, y = Income, group = incomeType),
    fun = mean,
    geom = "line",
    position = position_dodge(width = 0.75),
    color = "grey60",
    linewidth = 0.5
  ) +
  stat_summary(
    aes(x = Gender, y = Income, group = incomeType),
    fun = mean,
    geom = "point",
    position = position_dodge(width = 0.75),
    shape = 18,
    size = 3,
    color = "grey60"
  ) +
  stat_summary(
    aes(x = Gender, y = Income, group = incomeType),
    fun = mean,
    fun.min = function(x) mean(x) - sd(x),
    fun.max = function(x) mean(x) + sd(x),
    geom = "errorbar",
    position = position_dodge(width = 0.75),
    width = 0.2,
    color = "grey60"
  )


```

# difference

```{r}


dt.diff = dt.long %>%
  tidyr::pivot_wider(
    names_from = incomeType,
    values_from = Income
  ) %>%
  dplyr::rename(
    IncomeAfter = `Income after social transfers`,
    IncomeBefore = `Income before social transfers`
  ) %>%
  dplyr::mutate(Diff = IncomeAfter - IncomeBefore)


dt.summary = dt.diff %>%
  dplyr::group_by(Gender, Education) %>%
  dplyr::summarise(
    MeanDiff = mean(Diff, na.rm = TRUE),
    SE = sd(Diff, na.rm = TRUE) / sqrt(dplyr::n()),
    .groups = "drop"
  )

ggplot(dt.diff, aes(x = Gender, y = Diff, fill = Gender)) +
  geom_boxplot(outlier.shape = 21, outlier.fill = "white") +
  facet_wrap(~ Education, ncol = 4) +
  labs(
    title = "Distribution of Income Difference (After - Before Transfers)",
    subtitle = "Boxplots by Gender, Faceted by Education",
    x = "Gender",
    y = "Income Difference"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  geom_hline(yintercept = 0, alpha = 0) +
  scale_fill_manual(values = pal[c(7,3)])


```


# ratio

```{r}

dt.diff = dt.long %>%
  tidyr::pivot_wider(
    names_from = incomeType,
    values_from = Income
  ) %>%
  dplyr::rename(
    IncomeAfter = `Income after social transfers`,
    IncomeBefore = `Income before social transfers`
  ) %>%
  dplyr::mutate(Ratio = IncomeAfter / IncomeBefore)

dt.summary = dt.diff %>%
  dplyr::group_by(Gender, Education) %>%
  dplyr::summarise(
    MeanRatio = mean(Ratio, na.rm = TRUE),
    SE = sd(Ratio, na.rm = TRUE) / sqrt(dplyr::n()),
    .groups = "drop"
  )

ggplot(dt.diff, aes(x = Gender, y = Ratio, fill = Gender)) +
  geom_boxplot(outlier.shape = 21, outlier.fill = "white") +
  geom_hline(yintercept = 1, alpha = 0) +  # invisible reference line at ratio = 1
  facet_wrap(~ Education, ncol = 4) +
  labs(
    title = "Distribution of Income Ratio (After / Before Transfers)",
    subtitle = "Boxplots by Gender, Faceted by Education",
    x = "Gender",
    y = "Income Ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  geom_hline(yintercept = 1, alpha = 0) +
  scale_fill_manual(values = pal[c(8,4)])

fp = file.path('..', 'output')
fn = 'myplot.svg'
ggsave(file.path(fp, fn), 
       plot = get_last_plot(), 
       device = 'svg', 
       width = 8, 
       height = 6, 
       units = "in",
       dpi = 300)

```

# sessionInfo

```{r}

sessionInfo()

```


# snapshot environment

```{r}

renv::snapshot()


```

# restore enviroment

- installs the exact versions from renv.lock.


```{r}


# renv::restore()


```

